<script type="module">
(async () => {
  const q = new URLSearchParams(location.search);
  const wantPF = q.get('pf') === '1' || location.hash === '#pf';
  if (!wantPF) return;

  // 1) SW & Cache entschärfen (iOS/Safari vermeidet sonst dynamische Import-Hänger)
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
  } catch {}

  // 2) Engine-Start unterbinden, bis Preflight läuft
  window.__NO_BOOT = true;
  window.__suppressBootGuard = true;  // kein rotes Boot-Overlay

  // 3) Preflight laden und starten (ohne Cache)
  try {
    const m = await import('./preflight.js?ts=' + Date.now());
    await m.diagnose();
  } catch (e) {
    alert('Preflight konnte nicht geladen werden:\n' + (e?.message || e));
  }
})();
</script>