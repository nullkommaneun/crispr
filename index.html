<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CRISPR Genetics Lab</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <!-- Fehler-Overlay -->
  <div id="errorOverlay" class="hidden" role="alert" aria-live="assertive"></div>

  <!-- Toolbar -->
  <header class="toolbar" id="toolbar">
    <div class="toolbar-row">
      <button id="btnPlayPause">‚ñ∂Ô∏è Play</button>
      <button id="btnReset">üîÑ Reset</button>

      <label>Timescale</label>
      <button id="btnSpeedCycle">‚ö° 1√ó</button>

      <label for="mutationRate">Mutation</label>
      <input id="mutationRate" type="range" min="0" max="10" value="0.5" step="0.1" />
      <span id="mutationRateVal" class="mono">0.5 %</span>

      <label for="foodRate">Nahrung (pro Sekunde)</label>
      <input id="foodRate" type="range" min="0" max="360" value="90" step="1" />
      <span id="foodRateVal" class="mono">90 /s</span>

      <label>Highlight</label>
      <button id="btnHighlightCycle">Alle St√§mme</button>

      <button id="btnEditor">üß¨ Editor</button>
    </div>
  </header>

  <!-- Canvas -->
  <main id="main">
    <canvas id="simCanvas" width="800" height="520"></canvas>
  </main>

  <!-- DNA Daily (Narrative) -->
  <section id="narrativeSection" aria-label="Boulevard-Schlagzeilen">
    <header class="paperHead">
      <span class="paperTitle">DNA Daily</span>
      <span class="paperSub">Breaking News aus dem Labor</span>
    </header>
    <div id="narrativePanel" class="scrollbox" tabindex="0" aria-live="polite"></div>
  </section>

  <!-- Ticker -->
  <footer id="ticker" aria-live="polite">
    <div id="tickerInner"><div id="tickerContent"></div></div>
  </footer>

  <!-- Editor-Modal -->
  <dialog id="editorModal" aria-labelledby="editorTitle">
    <form method="dialog" id="editorForm">
      <header class="modalHeader">
        <h2 id="editorTitle">CRISPR-Editor</h2>
        <button id="editorClose" value="cancel" title="Schlie√üen">‚úñ</button>
      </header>

      <div class="modalBody">
        <section class="editorLeft">
          <h3>Traits anpassen</h3>
          <div class="traitRow" data-trait="TEM"><label>TEM ‚Äì Tempo</label><div class="stepper"><button type="button" class="dec">-1</button><output class="val">5</output><button type="button" class="inc">+1</button></div></div>
          <div class="traitRow" data-trait="GRO"><label>GR√ñ ‚Äì Gr√∂√üe</label><div class="stepper"><button type="button" class="dec">-1</button><output class="val">5</output><button type="button" class="inc">+1</button></div></div>
          <div class="traitRow" data-trait="EFF"><label>EFF ‚Äì Effizienz</label><div class="stepper"><button type="button" class="dec">-1</button><output class="val">5</output><button type="button" class="inc">+1</button></div></div>
          <div class="traitRow" data-trait="SCH"><label>SCH ‚Äì Schutz</label><div class="stepper"><button type="button" class="dec">-1</button><output class="val">5</output><button type="button" class="inc">+1</button></div></div>
          <div class="editorActions"><button id="editorApply" class="primary" type="submit" value="ok">√úbernehmen</button></div>
          <p class="hint mono">Neue Zellen aus dem Editor starten immer als <strong>neuer Stamm</strong>.</p>
        </section>

        <section class="editorRight">
          <h3>Lebende Zellen ‚Ä¢ Prognose</h3>
          <div id="editorCellList" class="cellList"></div>
          <div class="advisorBox">
            <div class="advisorHeader"><strong>KI-Advisor:</strong> <span id="editorAdvisorStatus">Aus</span></div>
            <div class="advisorCtrls">
              <button type="button" id="editorAdvisorToggle">Modus: Umschalten</button>
              <input type="text" id="editorModelUrl" placeholder="models/model.json" value="models/model.json" />
              <button type="button" id="editorModelLoad">Modell laden</button>
            </div>
            <small id="editorAdvisorNote">Modi: Aus ‚Ä¢ Heuristik ‚Ä¢ Modell (TensorFlow.js)</small>
          </div>
        </section>
      </div>
    </form>
  </dialog>

  <!-- Booter: l√§dt Module nacheinander und meldet EXAKT, welche Datei scheitert -->
  <script type="module">
    const ov = document.getElementById('errorOverlay');
    const show = (msg)=>{ if(ov){ ov.textContent=msg; ov.classList.add('show'); } };

    async function safeImport(spec){
      try {
        return await import(spec);
      } catch (e) {
        try {
          // Diagnose: gibt es die Datei? Stimmt der MIME-Type?
          const url = spec.replace(/\?.*$/, '');
          const res = await fetch(url, { cache: 'no-store' });
          const ct  = (res.headers.get('content-type') || '').toLowerCase();
          if (!res.ok) {
            show(`‚ö†Ô∏è Import fehlgeschlagen: ${url} ‚Äî HTTP ${res.status} ${res.statusText}`);
          } else if (!/javascript|ecmascript/.test(ct)) {
            show(`‚ö†Ô∏è Import fehlgeschlagen: ${url} ‚Äî MIME "${ct}" (vermutlich 404-HTML).`);
          } else {
            show(`‚ö†Ô∏è Import fehlgeschlagen: ${url} ‚Äî ${e?.message || e}`);
          }
        } catch (e2) {
          show(`‚ö†Ô∏è Import fehlgeschlagen: ${spec} ‚Äî Netzwerk/Fetch-Problem.`);
        }
        console.error('[Boot import error]', spec, e);
        throw e;
      }
    }

    (async () => {
      try {
        // 1) Fehler-Manager fr√ºh
        await safeImport('./errorManager.js');

        // 2) Basismodule (exakte Reihenfolge; KEINE Querystrings ‚Üí keine Cache-Verwirrung)
        await safeImport('./event.js');
        await safeImport('./genetics.js');
        await safeImport('./entities.js');
        await safeImport('./reproduction.js');
        await safeImport('./renderer.js');
        await safeImport('./ticker.js');
        await safeImport('./advisor.js');
        await safeImport('./editor.js');
        await safeImport('./narrative/panel.js');
        await safeImport('./spawn.js');

        // 3) Engine zuletzt
        await safeImport('./engine.js');
      } catch (err) {
        // safeImport hat bereits den konkreten Dateinamen angezeigt
      }
    })();
  </script>

  <script nomodule>
    const ov = document.getElementById('errorOverlay');
    if(ov){ ov.textContent = '‚ö†Ô∏è Dieser Browser unterst√ºtzt keine ES-Module.'; ov.classList.add('show'); }
  </script>
</body>
</html>