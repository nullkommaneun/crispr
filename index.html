<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CRISPR Genetics Lab</title>
  <link rel="stylesheet" href="./style.css?v=apoc6" />
</head>
<body>
  <!-- Fehler-Overlay (rot, oben) -->
  <div id="errorOverlay" class="hidden" role="alert" aria-live="assertive"></div>

  <!-- Toolbar -->
  <header class="toolbar" id="toolbar">
    <div class="toolbar-row">
      <button id="btnPlayPause" title="Abspielen/Pausieren (Leertaste)">‚ñ∂Ô∏è Play</button>
      <button id="btnReset" title="Simulation zur√ºcksetzen">üîÑ Reset</button>

      <label>Timescale</label>
      <!-- Zyklus-Button: 1√ó ‚Üí 5√ó ‚Üí 10√ó -->
      <button id="btnSpeedCycle" title="Geschwindigkeit durchschalten">‚ö° 1√ó</button>

      <label for="mutationRate">Mutation</label>
      <input id="mutationRate" type="range" min="0" max="100" value="10" step="1" />
      <span id="mutationRateVal" class="mono">10%</span>

      <label for="foodRate">Nahrung</label>
      <input id="foodRate" type="range" min="0" max="240" value="90" step="5" />
      <span id="foodRateVal" class="mono">90</span>

      <label>Highlight</label>
      <!-- Zyklus-Button: Alle ‚Üí Stamm 1 ‚Üí Stamm 2 ‚Üí ‚Ä¶ -->
      <button id="btnHighlightCycle" title="St√§mme durchschalten">Alle St√§mme</button>

      <button id="btnEditor" title="CRISPR-Editor √∂ffnen">üß¨ Editor</button>

      <button id="btnExport" title="Welt exportieren">‚¨áÔ∏è Export</button>
      <label class="importLabel">
        ‚¨ÜÔ∏è Import
        <input id="fileImport" type="file" accept="application/json" />
      </label>

      <button id="btnAdvisor" title="KI-Berater umschalten">ü§ñ Advisor</button>
      <span id="advisorStatus" class="status-badge">Berater: Aus</span>
    </div>
  </header>

  <!-- Spielfl√§che -->
  <main id="main">
    <canvas id="simCanvas" width="800" height="520"></canvas>
  </main>

  <!-- Narrative-Panel -->
  <section id="narrativeSection" aria-label="Boulevard-Schlagzeilen">
    <header class="paperHead">
      <span class="paperTitle">DNA Daily</span>
      <span class="paperSub">Breaking News aus dem Labor</span>
    </header>
    <div id="narrativePanel" class="scrollbox" tabindex="0" aria-live="polite"></div>
  </section>

  <!-- Ticker -->
  <footer id="ticker" aria-live="polite">
    <div id="tickerInner">
      <div id="tickerContent"></div>
    </div>
  </footer>

  <!-- Editor-Modal -->
  <dialog id="editorModal" aria-labelledby="editorTitle">
    <form method="dialog" id="editorForm">
      <header class="modalHeader">
        <h2 id="editorTitle">CRISPR-Editor</h2>
        <button id="editorClose" value="cancel" title="Schlie√üen">‚úñ</button>
      </header>

      <div class="modalBody">
        <section class="editorLeft">
          <h3>Traits anpassen</h3>
          <div class="traitRow" data-trait="TEM">
            <label>TEM ‚Äì Tempo</label>
            <div class="stepper">
              <button type="button" class="dec">-1</button>
              <output class="val">5</output>
              <button type="button" class="inc">+1</button>
            </div>
          </div>
          <div class="traitRow" data-trait="GRO">
            <label>GR√ñ ‚Äì Gr√∂√üe</label>
            <div class="stepper">
              <button type="button" class="dec">-1</button>
              <output class="val">5</output>
              <button type="button" class="inc">+1</button>
            </div>
          </div>
          <div class="traitRow" data-trait="EFF">
            <label>EFF ‚Äì Effizienz</label>
            <div class="stepper">
              <button type="button" class="dec">-1</button>
              <output class="val">5</output>
              <button type="button" class="inc">+1</button>
            </div>
          </div>
          <div class="traitRow" data-trait="SCH">
            <label>SCH ‚Äì Schutz</label>
            <div class="stepper">
              <button type="button" class="dec">-1</button>
              <output class="val">5</output>
              <button type="button" class="inc">+1</button>
            </div>
          </div>
          <div class="editorActions">
            <button id="editorApply" class="primary" type="submit" value="ok">√úbernehmen</button>
          </div>
          <p class="hint mono">Neue Zellen aus dem Editor starten immer als <strong>neuer Stamm</strong>.</p>
        </section>

        <section class="editorRight">
          <h3>Lebende Zellen ‚Ä¢ Prognose</h3>
          <div id="editorCellList" class="cellList"></div>
          <div class="advisorBox">
            <div><strong>KI-Advisor:</strong> <span id="editorAdvisorStatus">Heuristik aktiv</span></div>
            <small id="editorAdvisorNote">Mit Modell: ‚ÄûModell geladen‚Äú (TensorFlow.js) ‚Ä¢ Ohne: Heuristik</small>
          </div>
        </section>
      </div>
    </form>
  </dialog>

  <!-- Watchdog (informativ) -->
  <script>
    (function(){
      window.__CRISPR_WATCHDOG__ = setTimeout(function(){
        const ov = document.getElementById('errorOverlay');
        if(!ov) return;
        ov.textContent = '‚ö†Ô∏è Module laden langsam oder wurden blockiert. Bitte neu laden. Details in der Konsole.';
        ov.classList.add('show');
      }, 2500);
    })();
  </script>

  <!-- ES-Module robust importieren -->
  <script type="module">
    (async () => {
      try{
        await import('./engine.js?v=apoc6');
        clearTimeout(window.__CRISPR_WATCHDOG__);
      }catch(err){
        clearTimeout(window.__CRISPR_WATCHDOG__);
        const ov = document.getElementById('errorOverlay');
        if(ov){
          ov.textContent = '‚ö†Ô∏è Module konnten nicht geladen werden: ' +
            (err?.message || String(err)) +
            ' ‚Äî Pfade/Dateinamen pr√ºfen (GitHub Pages: Gro√ü/Kleinschreibung).';
          ov.classList.add('show');
        }
        console.error('[CRISPR] Modul-Importfehler', err);
      }
    })();
  </script>

  <script nomodule>
    const ov = document.getElementById('errorOverlay');
    if(ov){ ov.textContent = '‚ö†Ô∏è Dieser Browser unterst√ºtzt keine ES-Module.'; ov.classList.add('show'); }
  </script>
</body>
</html>